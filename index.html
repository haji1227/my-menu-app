<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Menu</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 10px; padding-bottom: 150px; background: #f8f9fa; color: #2d3748; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .month-nav { display: flex; align-items: center; gap: 15px; font-size: 1.1rem; font-weight: bold; }
        .btn-nav { background: none; border: none; font-size: 1.2rem; padding: 5px 10px; cursor: pointer; color: #4a5568; }
        .btn-setting { font-size: 0.8rem; background: #edf2f7; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; }

        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #cbd5e0;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .weekday-header {
            background: #f7fafc; padding: 8px 4px; text-align: center; font-size: 0.75rem; font-weight: bold; color: #718096;
        }
        
        /* Date Cell */
        .day-cell {
            background: white; min-height: 80px; padding: 4px; position: relative; cursor: pointer;
            display: flex; flex-direction: column; gap: 2px;
        }
        .day-cell.other-month { background: #f9fafb; color: #cbd5e0; }
        .day-cell.today { background: #fffaf0; }
        .day-cell.selected { background: #ebf8ff; box-shadow: inset 0 0 0 2px #4299e1; }
        
        .date-number { font-size: 0.75rem; font-weight: bold; margin-bottom: 2px; padding-left: 2px; }
        
        /* Dish Chips */
        .dish-chip {
            font-size: 0.7rem; padding: 2px 4px; border-radius: 4px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            display: flex; align-items: center; gap: 4px;
            color: #2d3748; border: 1px solid transparent;
        }
        /* Color coding by meal type */
        .dish-chip.dinner { background: #edf2f7; border-left: 3px solid #2d3748; } /* Default/Dinner */
        .dish-chip.lunch { background: #f0fff4; border-left: 3px solid #48bb78; }
        .dish-chip.breakfast { background: #fffaf0; border-left: 3px solid #ecc94b; }
        
        .dish-chip.has-link { border-right: 3px solid #ed8936; } /* Right border for link indicator */

        /* Fixed Input Bar */
        .input-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.98);
            border-top: 1px solid #e2e8f0; padding: 12px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08); z-index: 100;
        }
        .bar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .selected-date-label { font-size: 0.75rem; color: #718096; font-weight: bold; }
        
        /* Meal Type Selector (Segmented Control style) */
        .meal-selector { display: flex; background: #edf2f7; border-radius: 6px; padding: 2px; }
        .radio-label {
            font-size: 0.75rem; padding: 4px 8px; cursor: pointer; border-radius: 4px; color: #718096; font-weight: bold;
        }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + .radio-label { background: white; color: #2d3748; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        .input-row-main { display: flex; gap: 8px; max-width: 900px; margin: 0 auto; }
        .input-row-sub { display: none; margin-top: 10px; max-width: 900px; margin: 0 auto; animation: slideDown 0.2s; }
        
        input[type="text"] { padding: 10px; border: 1px solid #cbd5e0; border-radius: 8px; font-size: 16px; flex: 1; outline: none; }
        .btn-icon { background: #edf2f7; border: none; border-radius: 8px; width: 40px; height: 40px; font-size: 1.1rem; cursor: pointer; flex-shrink: 0; }
        .btn-icon.active { background: #4299e1; color: white; }
        .btn-add { background: #2d3748; color: white; border: none; padding: 0 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: flex-end; }
        .modal-content { background: white; width: 100%; max-width: 600px; margin: 0 auto; border-radius: 20px 20px 0 0; padding: 20px; max-height: 70vh; overflow-y: auto; }
        .history-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; cursor: pointer; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="month-nav">
            <button class="btn-nav" onclick="changeMonth(-1)">â€¹</button>
            <span id="currentMonthDisplay">Loading...</span>
            <button class="btn-nav" onclick="changeMonth(1)">â€º</button>
        </div>
        <div>
            <button onclick="shareBackup()" class="btn-setting">ðŸ“¤ Save</button>
            <button onclick="document.getElementById('fileInput').click()" class="btn-setting">ðŸ“¥ Load</button>
        </div>
        <input type="file" id="fileInput" style="display:none" onchange="importData(this)">
    </div>

    <div class="calendar-grid" id="calendarGrid">
        <div class="weekday-header">Mon</div>
        <div class="weekday-header">Tue</div>
        <div class="weekday-header">Wed</div>
        <div class="weekday-header">Thu</div>
        <div class="weekday-header">Fri</div>
        <div class="weekday-header" style="color:#3182ce">Sat</div>
        <div class="weekday-header" style="color:#e53e3e">Sun</div>
        </div>
</div>

<div class="input-bar">
    <div class="bar-header">
        <span class="selected-date-label" id="selectedDateDisplay">Select a date</span>
        <div class="meal-selector">
            <label>
                <input type="radio" name="mealType" value="breakfast">
                <span class="radio-label">Breakfast</span>
            </label>
            <label>
                <input type="radio" name="mealType" value="lunch">
                <span class="radio-label">Lunch</span>
            </label>
            <label>
                <input type="radio" name="mealType" value="dinner" checked>
                <span class="radio-label">Dinner</span>
            </label>
        </div>
    </div>

    <div class="input-row-main">
        <button class="btn-icon" onclick="openHistory()">ðŸ“–</button>
        <input type="text" id="dishName" placeholder="Menu...">
        <button class="btn-icon" onclick="toggleLinkInput()" id="linkToggleBtn">ðŸ“Ž</button>
        <button onclick="addDish()" class="btn-add">Add</button>
    </div>
    <div class="input-row-sub" id="linkInputRow">
        <input type="text" id="notionLink" placeholder="Paste Notion URL here...">
    </div>
</div>

<div id="historyModal" class="modal-overlay" onclick="closeHistory(event)">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <h2>Library ðŸ“š</h2>
            <button onclick="document.getElementById('historyModal').style.display='none'" style="background:none; border:none; font-size:1.5rem;">Ã—</button>
        </div>
        <div id="historyList"></div>
    </div>
</div>

<script>
    // Data Structure: { "2026-01-19": [ {id:123, name:"Curry", link:"...", type:"dinner"} ] }
    let plannerData = JSON.parse(localStorage.getItem('myMenuApp_v2_planner')) || {};
    let history = JSON.parse(localStorage.getItem('myMenuApp_history')) || [];
    
    let viewDate = new Date();
    let selectedDateStr = new Date().toISOString().split('T')[0];

    // Icons for display
    const mealIcons = { breakfast: 'â˜€ï¸', lunch: 'ðŸ±', dinner: 'ðŸŒ™' };
    const sortOrder = { breakfast: 1, lunch: 2, dinner: 3 };

    function init() {
        renderCalendar();
        updateSelectionDisplay();
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        // Keep first 7 elements (headers)
        while(grid.children.length > 7) grid.removeChild(grid.lastChild);

        const year = viewDate.getFullYear();
        const month = viewDate.getMonth();
        
        document.getElementById('currentMonthDisplay').textContent = 
            viewDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        
        // Monday Start Logic: (Day + 6) % 7. Sun(0)->6, Mon(1)->0
        const startDayIndex = (firstDay.getDay() + 6) % 7;

        // Previous Month Padding
        for (let i = 0; i < startDayIndex; i++) {
            const cell = document.createElement('div');
            cell.className = 'day-cell other-month';
            grid.appendChild(cell);
        }

        // Days
        const todayStr = new Date().toISOString().split('T')[0];

        for (let d = 1; d <= daysInMonth; d++) {
            const dateObj = new Date(year, month, d);
            const y = dateObj.getFullYear();
            const m = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            const dateKey = `${y}-${m}-${day}`;

            const cell = document.createElement('div');
            cell.className = 'day-cell';
            if (dateKey === todayStr) cell.classList.add('today');
            if (dateKey === selectedDateStr) cell.classList.add('selected');

            cell.onclick = () => selectDate(dateKey);
            cell.innerHTML = `<div class="date-number">${d}</div>`;

            if (plannerData[dateKey]) {
                // Sort by meal type
                plannerData[dateKey].sort((a,b) => (sortOrder[a.type||'dinner'] - sortOrder[b.type||'dinner']));

                plannerData[dateKey].forEach(dish => {
                    const type = dish.type || 'dinner';
                    const chip = document.createElement('div');
                    chip.className = `dish-chip ${type} ${dish.link ? 'has-link' : ''}`;
                    // Show icon + name
                    chip.innerHTML = `<span>${mealIcons[type]}</span> ${dish.name}`;
                    chip.onclick = (e) => {
                        e.stopPropagation();
                        if (confirm(`Delete "${dish.name}"?`)) {
                            removeDish(dateKey, dish.id);
                        } else if(dish.link) {
                            window.open(dish.link, '_blank');
                        }
                    };
                    cell.appendChild(chip);
                });
            }
            grid.appendChild(cell);
        }
    }

    function selectDate(dateKey) {
        selectedDateStr = dateKey;
        renderCalendar();
        updateSelectionDisplay();
    }

    function updateSelectionDisplay() {
        const d = new Date(selectedDateStr);
        const label = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        document.getElementById('selectedDateDisplay').textContent = `${label}`;
    }

    function changeMonth(delta) {
        viewDate.setMonth(viewDate.getMonth() + delta);
        renderCalendar();
    }

    function addDish() {
        const nameInput = document.getElementById('dishName');
        const linkInput = document.getElementById('notionLink');
        // Get selected meal type
        const mealType = document.querySelector('input[name="mealType"]:checked').value;
        
        const name = nameInput.value;
        const link = linkInput.value;

        if (name && selectedDateStr) {
            if (!plannerData[selectedDateStr]) plannerData[selectedDateStr] = [];
            
            plannerData[selectedDateStr].push({
                id: Date.now(),
                name: name,
                link: link,
                type: mealType
            });

            if (!history.some(h => h.name === name)) {
                history.push({ name: name, link: link });
                localStorage.setItem('myMenuApp_history', JSON.stringify(history));
            }

            save();
            renderCalendar();
            nameInput.value = '';
            linkInput.value = '';
        }
    }

    function removeDish(dateKey, id) {
        plannerData[dateKey] = plannerData[dateKey].filter(d => d.id !== id);
        if(plannerData[dateKey].length === 0) delete plannerData[dateKey];
        save();
        renderCalendar();
    }

    // --- History & Utils ---

    function openHistory() {
        const modal = document.getElementById('historyModal');
        const list = document.getElementById('historyList');
        const currentType = document.querySelector('input[name="mealType"]:checked').value;
        const currentIcon = mealIcons[currentType];

        list.innerHTML = '';
        history.forEach(item => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `<span style="font-weight:bold">${item.name} ${item.link?'ðŸ”—':''}</span><span style="color:#4299e1">+Add as ${currentIcon}</span>`;
            div.onclick = () => {
                document.getElementById('dishName').value = item.name;
                document.getElementById('notionLink').value = item.link || '';
                addDish();
                modal.style.display = 'none';
            };
            list.appendChild(div);
        });
        modal.style.display = 'flex';
    }
    
    function closeHistory(e) { if(e.target.id === 'historyModal') document.getElementById('historyModal').style.display = 'none'; }
    function toggleLinkInput() {
        const row = document.getElementById('linkInputRow');
        const btn = document.getElementById('linkToggleBtn');
        if (row.style.display === 'block') { row.style.display = 'none'; btn.classList.remove('active'); } 
        else { row.style.display = 'block'; btn.classList.add('active'); }
    }

    function save() { localStorage.setItem('myMenuApp_v2_planner', JSON.stringify(plannerData)); }

    // --- Backup (Share API) ---
    async function shareBackup() {
        const data = { planner: plannerData, history: history };
        const file = new File([JSON.stringify(data, null, 2)], "menu-backup-monthly.json", {type: "text/plain"});
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try { await navigator.share({ files: [file], title: 'Menu Backup', text: 'Monthly Menu Data' }); } 
            catch (err) { console.log(err); }
        } else { downloadFallback(file); }
    }
    function downloadFallback(file) {
        const url = URL.createObjectURL(file);
        const a = document.createElement('a'); a.href = url; a.download = "menu-backup-monthly.json"; a.click();
    }
    function importData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if(data.planner || data.history) {
                    if(data.planner) plannerData = data.planner;
                    if(data.history) {
                        history = data.history;
                        localStorage.setItem('myMenuApp_history', JSON.stringify(history));
                    }
                    save(); renderCalendar(); alert('Restored!');
                }
            } catch(err) { alert('Error reading file'); }
        };
        reader.readAsText(file);
    }

    init();
</script>

</body>
</html>
