<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#f8f9fa">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Meal Plan</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üç≥</text></svg>">
    <link rel="apple-touch-icon" href="icon.png">

    <style>
        /* Layout Adjustments for App-like feel */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            padding: 5px; 
            padding-bottom: 160px; /* Safe area for input bar */
            padding-top: env(safe-area-inset-top); /* Notch support */
            background: #f8f9fa; 
            color: #2d3748; 
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight */
            user-select: none; /* App-like feel (no text selection) */
        }
        
        input, textarea { user-select: text; }

        .container { max-width: 1000px; margin: 0 auto; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 5px;}
        .month-nav { display: flex; align-items: center; gap: 10px; font-size: 1.0rem; font-weight: bold; }
        .btn-nav { background: none; border: none; font-size: 1.4rem; padding: 5px 10px; cursor: pointer; color: #4a5568; }
        .btn-setting { font-size: 0.75rem; background: #edf2f7; border: none; padding: 8px 12px; border-radius: 20px; cursor: pointer; white-space: nowrap; font-weight:600;}

        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #cbd5e0;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        
        .weekday-header {
            background: #f7fafc; padding: 8px 2px; text-align: center; font-size: 0.7rem; font-weight: bold; color: #718096;
        }
        
        /* Date Cell */
        .day-cell {
            background: white; min-height: 75px; padding: 2px; position: relative; cursor: pointer;
            display: flex; flex-direction: column; gap: 2px;
        }
        .day-cell:active { background: #f7fafc; } 
        /* Other month styling: slightly gray background, lighter text */
        .day-cell.other-month { background: #fbfbfb; color: #a0aec0; }
        .day-cell.today { background: #fffaf0; }
        .day-cell.selected { background: #ebf8ff; box-shadow: inset 0 0 0 2px #4299e1; }
        
        .date-number { font-size: 0.7rem; font-weight: bold; margin-bottom: 1px; padding-left: 2px; }
        
        /* Dish Chips */
        .dish-chip {
            font-size: 0.65rem; padding: 3px 4px; border-radius: 4px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            display: flex; align-items: center; gap: 2px;
            color: #2d3748; border: 1px solid transparent;
            line-height: 1.2; margin-bottom: 1px;
        }
        .dish-chip span { font-size: 0.7rem; } 
        
        /* Faded chips for other months */
        .day-cell.other-month .dish-chip { opacity: 0.7; }

        .dish-chip.dinner { background: #edf2f7; border-left: 2px solid #2d3748; }
        .dish-chip.lunch { background: #f0fff4; border-left: 2px solid #48bb78; }
        .dish-chip.breakfast { background: #fffaf0; border-left: 2px solid #ecc94b; }
        .dish-chip.has-link { border-right: 2px solid #ed8936; }

        /* Fixed Input Bar */
        .input-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #e2e8f0; padding: 10px 10px 20px 10px; 
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08); z-index: 100;
        }
        .bar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .selected-date-label { font-size: 0.8rem; color: #2d3748; font-weight: bold; }
        
        /* Meal Type Selector */
        .meal-selector { display: flex; background: #edf2f7; border-radius: 8px; padding: 3px; }
        .radio-label {
            font-size: 0.7rem; padding: 6px 10px; cursor: pointer; border-radius: 6px; color: #718096; font-weight: bold; transition: all 0.2s;
        }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + .radio-label { background: white; color: #2d3748; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        .input-row-main { display: flex; gap: 8px; max-width: 900px; margin: 0 auto; }
        .input-row-sub { display: none; margin-top: 10px; max-width: 900px; margin: 0 auto; animation: slideDown 0.2s; }
        
        input[type="text"] { 
            padding: 10px; border: 1px solid #cbd5e0; border-radius: 8px; font-size: 16px; flex: 1; outline: none; 
            -webkit-appearance: none; 
        }
        input[type="text"]:focus { border-color: #4299e1; }
        
        .btn-icon { background: #edf2f7; border: none; border-radius: 8px; width: 42px; height: 42px; font-size: 1.2rem; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center;}
        .btn-icon.active { background: #4299e1; color: white; }
        .btn-add { background: #2d3748; color: white; border: none; padding: 0 20px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }
        .btn-add:active { transform: scale(0.98); }

        /* Modal */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: flex-end; }
        .modal-content { background: white; width: 100%; max-width: 600px; margin: 0 auto; border-radius: 20px 20px 0 0; padding: 20px; max-height: 80vh; overflow-y: auto; padding-bottom: 40px;}
        .history-item { padding: 15px 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; cursor: pointer; }
        .history-item:active { background: #f7fafc; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="month-nav">
            <button class="btn-nav" onclick="changeMonth(-1)">‚Äπ</button>
            <span id="currentMonthDisplay">Loading...</span>
            <button class="btn-nav" onclick="changeMonth(1)">‚Ä∫</button>
        </div>
        <div style="display:flex; gap:8px;">
            <button onclick="shareBackup()" class="btn-setting">üì§ Save</button>
            <button onclick="document.getElementById('fileInput').click()" class="btn-setting">üì• Load</button>
        </div>
        <input type="file" id="fileInput" style="display:none" onchange="importData(this)">
    </div>

    <div class="calendar-grid" id="calendarGrid">
        <div class="weekday-header">Mon</div>
        <div class="weekday-header">Tue</div>
        <div class="weekday-header">Wed</div>
        <div class="weekday-header">Thu</div>
        <div class="weekday-header">Fri</div>
        <div class="weekday-header" style="color:#3182ce">Sat</div>
        <div class="weekday-header" style="color:#e53e3e">Sun</div>
    </div>
</div>

<div class="input-bar">
    <div class="bar-header">
        <span class="selected-date-label" id="selectedDateDisplay">Select a date</span>
        <div class="meal-selector">
            <label>
                <input type="radio" name="mealType" value="breakfast">
                <span class="radio-label">Breakfast</span>
            </label>
            <label>
                <input type="radio" name="mealType" value="lunch">
                <span class="radio-label">Lunch</span>
            </label>
            <label>
                <input type="radio" name="mealType" value="dinner" checked>
                <span class="radio-label">Dinner</span>
            </label>
        </div>
    </div>

    <div class="input-row-main">
        <button class="btn-icon" onclick="openHistory()">üìñ</button>
        <input type="text" id="dishName" placeholder="Menu...">
        <button class="btn-icon" onclick="toggleLinkInput()" id="linkToggleBtn">üìé</button>
        <button onclick="addDish()" class="btn-add">Add</button>
    </div>
    <div class="input-row-sub" id="linkInputRow">
        <input type="text" id="notionLink" placeholder="Paste Notion URL here...">
    </div>
</div>

<div id="historyModal" class="modal-overlay" onclick="closeHistory(event)">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
            <h2 style="margin:0; font-size:1.2rem;">Library üìö</h2>
            <button onclick="document.getElementById('historyModal').style.display='none'" style="background:#edf2f7; border:none; width:30px; height:30px; border-radius:50%; font-size:1.2rem; display:flex; align-items:center; justify-content:center;">√ó</button>
        </div>
        <div id="historyList"></div>
    </div>
</div>

<script>
    let plannerData = JSON.parse(localStorage.getItem('myMenuApp_v2_planner')) || {};
    let history = JSON.parse(localStorage.getItem('myMenuApp_history')) || [];
    
    let viewDate = new Date();
    let selectedDateStr = new Date().toISOString().split('T')[0];

    const mealIcons = { breakfast: '‚òÄÔ∏è', lunch: 'üç±', dinner: 'üåô' };
    const sortOrder = { breakfast: 1, lunch: 2, dinner: 3 };

    function init() {
        renderCalendar();
        updateSelectionDisplay();
    }

    // Helper to format YYYY-MM-DD
    function formatDateKey(dateObj) {
        const y = dateObj.getFullYear();
        const m = String(dateObj.getMonth() + 1).padStart(2, '0');
        const d = String(dateObj.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    function renderCell(grid, dateObj, isCurrentMonth) {
        const dateKey = formatDateKey(dateObj);
        const cell = document.createElement('div');
        cell.className = 'day-cell';
        if (!isCurrentMonth) cell.classList.add('other-month');
        
        // Highlight logic
        const todayStr = formatDateKey(new Date());
        if (dateKey === todayStr) cell.classList.add('today');
        if (dateKey === selectedDateStr) cell.classList.add('selected');

        cell.onclick = () => selectDate(dateKey);
        cell.innerHTML = `<div class="date-number">${dateObj.getDate()}</div>`;

        // Render Dishes
        if (plannerData[dateKey]) {
            plannerData[dateKey].sort((a,b) => (sortOrder[a.type||'dinner'] - sortOrder[b.type||'dinner']));
            plannerData[dateKey].forEach(dish => {
                const type = dish.type || 'dinner';
                const chip = document.createElement('div');
                chip.className = `dish-chip ${type} ${dish.link ? 'has-link' : ''}`;
                chip.innerHTML = `<span>${mealIcons[type]}</span> ${dish.name}`;
                chip.onclick = (e) => {
                    e.stopPropagation();
                    if (confirm(`Delete "${dish.name}"?`)) { removeDish(dateKey, dish.id); } 
                    else if(dish.link) { window.open(dish.link, '_blank'); }
                };
                cell.appendChild(chip);
            });
        }
        grid.appendChild(cell);
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        while(grid.children.length > 7) grid.removeChild(grid.lastChild);

        const year = viewDate.getFullYear();
        const month = viewDate.getMonth();
        
        document.getElementById('currentMonthDisplay').textContent = 
            viewDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        
        // Monday Start Logic: (Day + 6) % 7. Sun(0)->6, Mon(1)->0
        const startDayIndex = (firstDay.getDay() + 6) % 7;

        // 1. Previous Month Padding (Actual dates)
        const prevMonthLastDay = new Date(year, month, 0).getDate();
        for (let i = startDayIndex - 1; i >= 0; i--) {
            const d = prevMonthLastDay - i;
            const dateObj = new Date(year, month - 1, d); // Handles year rollover
            renderCell(grid, dateObj, false);
        }

        // 2. Current Month
        for (let d = 1; d <= daysInMonth; d++) {
            const dateObj = new Date(year, month, d);
            renderCell(grid, dateObj, true);
        }

        // 3. Next Month Padding (Fill remaining cells in last row)
        const totalCellsSoFar = startDayIndex + daysInMonth;
        const remainingCells = (7 - (totalCellsSoFar % 7)) % 7;
        
        for (let d = 1; d <= remainingCells; d++) {
            const dateObj = new Date(year, month + 1, d); // Handles year rollover
            renderCell(grid, dateObj, false);
        }
    }

    function selectDate(dateKey) {
        selectedDateStr = dateKey;
        renderCalendar();
        updateSelectionDisplay();
    }

    function updateSelectionDisplay() {
        const d = new Date(selectedDateStr);
        const label = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        document.getElementById('selectedDateDisplay').textContent = label;
    }

    function changeMonth(delta) {
        viewDate.setMonth(viewDate.getMonth() + delta);
        renderCalendar();
    }

    function addDish() {
        const nameInput = document.getElementById('dishName');
        const linkInput = document.getElementById('notionLink');
        const mealType = document.querySelector('input[name="mealType"]:checked').value;
        const name = nameInput.value;
        const link = linkInput.value;

        if (name && selectedDateStr) {
            if (!plannerData[selectedDateStr]) plannerData[selectedDateStr] = [];
            plannerData[selectedDateStr].push({ id: Date.now(), name: name, link: link, type: mealType });

            if (!history.some(h => h.name === name)) {
                history.push({ name: name, link: link });
                localStorage.setItem('myMenuApp_history', JSON.stringify(history));
            }
            save(); renderCalendar();
            nameInput.value = ''; linkInput.value = '';
        }
    }

    function removeDish(dateKey, id) {
        plannerData[dateKey] = plannerData[dateKey].filter(d => d.id !== id);
        if(plannerData[dateKey].length === 0) delete plannerData[dateKey];
        save(); renderCalendar();
    }

    function openHistory() {
        const modal = document.getElementById('historyModal');
        const list = document.getElementById('historyList');
        const currentType = document.querySelector('input[name="mealType"]:checked').value;
        const currentIcon = mealIcons[currentType];
        list.innerHTML = '';
        history.forEach(item => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `<span style="font-weight:bold">${item.name} ${item.link?'üîó':''}</span><span style="color:#4299e1; font-size:0.8rem; display:flex; align-items:center;">+ ${currentIcon}</span>`;
            div.onclick = () => {
                document.getElementById('dishName').value = item.name;
                document.getElementById('notionLink').value = item.link || '';
                addDish();
                modal.style.display = 'none';
            };
            list.appendChild(div);
        });
        modal.style.display = 'flex';
    }
    
    function closeHistory(e) { if(e.target.id === 'historyModal') document.getElementById('historyModal').style.display = 'none'; }
    function toggleLinkInput() {
        const row = document.getElementById('linkInputRow');
        const btn = document.getElementById('linkToggleBtn');
        if (row.style.display === 'block') { row.style.display = 'none'; btn.classList.remove('active'); } 
        else { row.style.display = 'block'; btn.classList.add('active'); }
    }
    function save() { localStorage.setItem('myMenuApp_v2_planner', JSON.stringify(plannerData)); }

    async function shareBackup() {
        const data = { planner: plannerData, history: history };
        const file = new File([JSON.stringify(data, null, 2)], "menu-backup-monthly.json", {type: "text/plain"});
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try { await navigator.share({ files: [file], title: 'Meal Plan Backup', text: 'Monthly Menu Data' }); } 
            catch (err) { console.log(err); }
        } else { downloadFallback(file); }
    }
    function downloadFallback(file) {
        const url = URL.createObjectURL(file);
        const a = document.createElement('a'); a.href = url; a.download = "menu-backup-monthly.json"; a.click();
    }
    function importData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if(data.planner || data.history) {
                    if(data.planner) plannerData = data.planner;
                    if(data.history) { history = data.history; localStorage.setItem('myMenuApp_history', JSON.stringify(history)); }
                    save(); renderCalendar(); alert('Restored!');
                }
            } catch(err) { alert('Error reading file'); }
        };
        reader.readAsText(file);
    }
    init();
</script>

</body>
</html>
